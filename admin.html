<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçâ Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        h1 { text-align: center; margin-bottom: 30px; }
        h1 span { color: #ffd700; }
        
        /* Login */
        #login {
            max-width: 400px;
            margin: 100px auto;
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }
        
        #login h2 { margin-bottom: 20px; }
        
        #login input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        #login input::placeholder { color: rgba(255,255,255,0.5); }
        
        #login button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .error { color: #ff6b6b; margin-top: 10px; }
        
        /* Dashboard */
        #dashboard { display: none; }
        
        /* Refresh Bar */
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .refresh-bar button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card .icon { font-size: 28px; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #ffd700; }
        .stat-card .label { font-size: 13px; opacity: 0.7; margin-top: 5px; }
        
        /* Panels */
        .panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .panel {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 20px;
        }
        
        .panel h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 16px;
        }
        
        /* Tables */
        .table-scroll { max-height: 350px; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }
        
        th { opacity: 0.6; font-size: 11px; text-transform: uppercase; }
        
        tr:hover { background: rgba(255,255,255,0.05); }
        
        .online-dot {
            width: 8px;
            height: 8px;
            background: #38ef7d;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .badge {
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .badge-payment { background: #38ef7d; color: #000; }
        .badge-online { background: #667eea; }
        .badge-game { background: #ffd700; color: #000; }
        .badge-new { background: #f093fb; }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            opacity: 0.5;
        }
        
        /* Activity */
        .activity-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 0 8px 8px 0;
        }
        
        .activity-item .time {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 4px;
        }
        
        /* Medal colors */
        .gold { color: #ffd700; }
        .silver { color: #c0c0c0; }
        .bronze { color: #cd7f32; }
        
        @media (max-width: 768px) {
            .panels { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-card .value { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login -->
        <div id="login">
            <h2>üîê Admin Login</h2>
            <input type="password" id="password" placeholder="Enter admin password">
            <button onclick="login()">Login</button>
            <div class="error" id="error"></div>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard">
            <h1>üçâ Fruit Merge <span>Admin</span></h1>
            
            <div class="refresh-bar">
                <span id="last-updated">Last updated: --</span>
                <div>
                    <label><input type="checkbox" id="auto-refresh" checked> Auto-refresh (30s)</label>
                    <button onclick="fetchData()">üîÑ Refresh</button>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <div class="value" id="stat-online">0</div>
                    <div class="label">Online Now</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üë§</div>
                    <div class="value" id="stat-users">0</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üéÆ</div>
                    <div class="value" id="stat-games">0</div>
                    <div class="label">Games Played</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üí∞</div>
                    <div class="value" id="stat-revenue">0</div>
                    <div class="label">Revenue (‚≠ê)</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üí≥</div>
                    <div class="value" id="stat-payments">0</div>
                    <div class="label">Payments</div>
                </div>
            </div>
            
            <!-- Panels -->
            <div class="panels">
                <!-- Online Users -->
                <div class="panel">
                    <h3>üë• Online Users</h3>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr><th>User</th><th>Score</th><th>Time</th></tr>
                            </thead>
                            <tbody id="online-table"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="no-online">No users online</div>
                </div>
                
                <!-- Recent Payments -->
                <div class="panel">
                    <h3>üí∞ Recent Payments</h3>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr><th>User</th><th>Item</th><th>Amount</th><th>Time</th></tr>
                            </thead>
                            <tbody id="payments-table"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="no-payments">No payments yet</div>
                </div>
                
                <!-- Top Players -->
                <div class="panel">
                    <h3>üèÜ Top Players (High Scores)</h3>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr><th>#</th><th>Player</th><th>Best Score</th><th>Games</th></tr>
                            </thead>
                            <tbody id="players-table"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="no-players">No players yet</div>
                </div>
                
                <!-- Top Spenders -->
                <div class="panel">
                    <h3>üíé Top Spenders</h3>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr><th>#</th><th>User</th><th>Spent</th></tr>
                            </thead>
                            <tbody id="spenders-table"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="no-spenders">No purchases yet</div>
                </div>
                
                <!-- Activity Log -->
                <div class="panel" style="grid-column: span 2;">
                    <h3>üìã Recent Activity</h3>
                    <div class="table-scroll" id="activity-log"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== CONFIG ==========
        const BACKEND = 'https://fruit-merge-backend-7p5k.onrender.com';
        
        let password = '';
        let refreshTimer = null;
        
        // ========== LOGIN ==========
        function login() {
            password = document.getElementById('password').value;
            
            fetch(`${BACKEND}/api/admin/dashboard?password=${password}`)
                .then(r => {
                    if (r.status === 401) throw new Error('Wrong password');
                    return r.json();
                })
                .then(data => {
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    updateDashboard(data);
                    startRefresh();
                })
                .catch(e => {
                    document.getElementById('error').textContent = e.message;
                });
        }
        
        document.getElementById('password').addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });
        
        // ========== FETCH DATA ==========
        function fetchData() {
            fetch(`${BACKEND}/api/admin/dashboard?password=${password}`)
                .then(r => r.json())
                .then(updateDashboard)
                .catch(e => console.error('Fetch error:', e));
        }
        
        // ========== UPDATE DASHBOARD ==========
        function updateDashboard(data) {
            const { stats, onlineUsers, recentPayments, topPlayers, topSpenders, recentActivity } = data;
            
            // Stats
            document.getElementById('stat-online').textContent = stats.onlineUsers || 0;
            document.getElementById('stat-users').textContent = stats.totalUsers || 0;
            document.getElementById('stat-games').textContent = stats.totalGamesPlayed || 0;
            document.getElementById('stat-revenue').textContent = stats.totalRevenue || 0;
            document.getElementById('stat-payments').textContent = stats.totalPayments || 0;
            
            // Online Users
            const onlineTable = document.getElementById('online-table');
            const hasOnline = onlineUsers && onlineUsers.length > 0;
            document.getElementById('no-online').style.display = hasOnline ? 'none' : 'block';
            
            onlineTable.innerHTML = (onlineUsers || []).map(u => `
                <tr>
                    <td><span class="online-dot"></span>${u.avatar || 'üéÆ'} <strong>${u.username || u.userId || 'Unknown'}</strong></td>
                    <td>${u.score || 0}</td>
                    <td>${formatDuration(Date.now() - u.joinedAt)}</td>
                </tr>
            `).join('');
            
            // Recent Payments
            const paymentsTable = document.getElementById('payments-table');
            const hasPayments = recentPayments && recentPayments.length > 0;
            document.getElementById('no-payments').style.display = hasPayments ? 'none' : 'block';
            
            paymentsTable.innerHTML = (recentPayments || []).map(p => `
                <tr>
                    <td><strong>${p.username || p.userId || 'Unknown'}</strong></td>
                    <td>${(p.item || '').split(':')[0]}</td>
                    <td><span class="badge badge-payment">${p.amount} ‚≠ê</span></td>
                    <td>${formatTime(p.timestamp)}</td>
                </tr>
            `).join('');
            
            // Top Players
            const playersTable = document.getElementById('players-table');
            const hasPlayers = topPlayers && topPlayers.length > 0;
            document.getElementById('no-players').style.display = hasPlayers ? 'none' : 'block';
            
            playersTable.innerHTML = (topPlayers || []).map((p, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1);
                const medalClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `
                    <tr>
                        <td class="${medalClass}">${medal}</td>
                        <td>${p.avatar || 'üéÆ'} <strong>${p.username || p.userId || 'Unknown'}</strong></td>
                        <td style="color:#ffd700;font-weight:bold">${p.highScore || 0}</td>
                        <td>${p.gamesPlayed || 0}</td>
                    </tr>
                `;
            }).join('');
            
            // Top Spenders
            const spendersTable = document.getElementById('spenders-table');
            const hasSpenders = topSpenders && topSpenders.length > 0;
            document.getElementById('no-spenders').style.display = hasSpenders ? 'none' : 'block';
            
            spendersTable.innerHTML = (topSpenders || []).map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${s.username || s.userId || 'Unknown'}</strong></td>
                    <td style="color:#38ef7d;font-weight:bold">${s.totalSpent || 0} ‚≠ê</td>
                </tr>
            `).join('');
            
            // Activity Log
            const activityLog = document.getElementById('activity-log');
            activityLog.innerHTML = (recentActivity || []).map(a => {
                const badge = getBadge(a.type);
                return `
                    <div class="activity-item">
                        <span class="badge ${badge.class}">${a.type.replace('_', ' ')}</span>
                        ${formatActivity(a)}
                        <div class="time">${formatTime(a.timestamp)}</div>
                    </div>
                `;
            }).join('') || '<div class="empty-state">No activity yet</div>';
            
            // Last updated
            document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }
        
        // ========== AUTO REFRESH ==========
        function startRefresh() {
            const checkbox = document.getElementById('auto-refresh');
            
            const setupTimer = () => {
                if (refreshTimer) clearInterval(refreshTimer);
                if (checkbox.checked) {
                    refreshTimer = setInterval(fetchData, 30000);
                }
            };
            
            checkbox.addEventListener('change', setupTimer);
            setupTimer();
        }
        
        // ========== HELPERS ==========
        function formatTime(ts) {
            if (!ts) return '--';
            return new Date(ts).toLocaleTimeString();
        }
        
        function formatDuration(ms) {
            const mins = Math.floor(ms / 60000);
            if (mins < 60) return `${mins}m`;
            return `${Math.floor(mins / 60)}h ${mins % 60}m`;
        }
        
        function getBadge(type) {
            if (type.includes('payment')) return { class: 'badge-payment' };
            if (type.includes('online')) return { class: 'badge-online' };
            if (type.includes('game')) return { class: 'badge-game' };
            if (type.includes('new')) return { class: 'badge-new' };
            return { class: 'badge-online' };
        }
        
        function formatActivity(a) {
            const d = a.data || {};
            const name = d.username || d.userId || 'Someone';
            
            switch(a.type) {
                case 'payment': return `<strong>${name}</strong> paid ${d.amount}‚≠ê for ${(d.item || '').split(':')[0]}`;
                case 'user_online': return `<strong>${name}</strong> came online`;
                case 'user_offline': return `<strong>${name}</strong> went offline`;
                case 'new_user': return `<strong>${name}</strong> joined! üéâ`;
                case 'game_start': return `<strong>${name}</strong> started a game`;
                case 'game_end': return `<strong>${name}</strong> scored <strong>${d.score}</strong>`;
                case 'referral': return `Referral: ${d.referrerId} ‚Üí ${d.newUserId}`;
                default: return JSON.stringify(d);
            }
        }
    </script>
</body>
</html>
